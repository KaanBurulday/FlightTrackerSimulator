<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map Example</title>
    <!-- Include Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Include Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map {
            height: 520px;
            width: 520px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="row">
        <!-- Left column -->
        <div class="col-6">
            <div class="p-3 border">
                <div id="map"></div>
            </div>
        </div>
        <!-- Right column -->
        <div class="col-4">
            <div class="row">
                <div class="col-12">
                    <div class="p-3 border">
                        <input type="button" onclick="envGenerate()" value="Generate Environment" class="btn btn-primary w-100">
                    </div>
                </div>
                <div class="col-12">
                    <div class="p-3 border">
                        <input type="button" onclick="envStart()" value="Start Environment" class="btn btn-success w-100">
                    </div>
                </div>
                <div class="col-12">
                    <div class="p-3 border">
                        <input type="button" onclick="envStop()" value="Stop Environment" class="btn btn-danger w-100">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    var plane_icon = L.Icon.extend({
        options: {
            iconUrl: 'plane_icon.png',
            iconSize: [16, 16], // size of the icon
            shadowSize: [0, 0], // size of the shadow
            iconAnchor: [8, 8], // point of the icon which will correspond to marker's location
            shadowAnchor: [0, 0],  // the same for the shadow
            popupAnchor: [0, 0]
        }
    });

    var airport_icon = L.Icon.extend({
        options: {
            iconUrl: 'airport_icon.png',
            iconSize: [24, 24], // size of the icon
            shadowSize: [0, 0], // size of the shadow
            iconAnchor: [12, 12], // point of the icon which will correspond to marker's location
            shadowAnchor: [0, 0],  // the same for the shadow
            popupAnchor: [0, 0]
        }
    });

    // Initialize Leaflet map
    var map = L.map('map', {
        center: [51.505, -0.09],
        zoom: 1,
        maxBounds: L.latLngBounds(L.latLng(-90, -180), L.latLng(90, 180)),
        maxBoundsViscosity: 1.0,
        noWrap: true
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
        maxZoom: 18,
        noWrap: true
    }).addTo(map);

    var markersGroup = L.layerGroup().addTo(map);

    // Add marker
    function addMarker(latDegrees, longDegrees, message, type) {
        var marker;
        if (type === "plane") {
            marker = L.marker([latDegrees, longDegrees], {icon: new plane_icon()}).addTo(markersGroup);
        } else if (type === "airport") {
            marker = L.marker([latDegrees, longDegrees], {icon: new airport_icon()}).addTo(markersGroup);
        } else {
            marker = L.marker([latDegrees, longDegrees]).addTo(markersGroup);
        }
        marker.bindPopup(message);
    }

    function clearMarkers() {
        markersGroup.clearLayers();
    }

    const envGenerateURL = "http://localhost:8080/GenerateEnv?iteration=20";
    const envStartURL = "http://localhost:8080/EnvStart";
    const envStopURL = "http://localhost:8080/EnvStop";

    function envGenerate() {
        fetch(envGenerateURL)
            .then(response => {
                // Check if the response is successful (status code 200-299)
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                // Parse the JSON response
                return response.json();
            })
            .then(() => {
                // Handle the parsed data
                console.log("successful generation!");
            })
            .catch(error => {
                // Handle any errors that occurred during the fetch
                console.error('There was a problem with the fetch operation:', error);
            });
    }

    function envStart() {
        fetch(envStartURL)
            .then(response => {
                // Check if the response is successful (status code 200-299)
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                // Parse the JSON response
                return response.json();
            })
            .then(() => {
                // Handle the parsed data
                console.log("successful generation!");
            })
            .catch(error => {
                // Handle any errors that occurred during the fetch
                console.error('There was a problem with the fetch operation:', error);
            });
    }

    function envStop() {
        fetch(envStopURL)
            .then(response => {
                // Check if the response is successful (status code 200-299)
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                // Parse the JSON response
                return response.json();
            })
            .then(() => {
                // Handle the parsed data
                console.log("successful generation!");
            })
            .catch(error => {
                // Handle any errors that occurred during the fetch
                console.error('There was a problem with the fetch operation:', error);
            });
    }

    function updateAirports() {
        $.get("/GetEnv", function (data) {
            // Assuming data is a JSON array of objects
            data.forEach(function (item) {
                var itemCoordinates = item.coordinates;
                addMarker(itemCoordinates.latDegrees,
                    itemCoordinates.longDegrees,
                    `<b>${item.code}</b><br>${item.name}.`,
                    "airport"
                )
            });
        });
    }

    function updatePlanes() {
        $.get("/Planes", function (data) {
            // Assuming data is a JSON array of objects
            if (data.length > 0) {
                data.forEach(function (item) {
                    var itemCoordinates = item.currentCoordinates;
                    addMarker(itemCoordinates.latDegrees,
                        itemCoordinates.longDegrees,
                        `<b>${item.planeCode}</b><br>${item.name}.`,
                        "plane"
                    )
                });
            }
        });
    }

    function UpdateAll() {
        clearMarkers();
        updateAirports();
        updatePlanes();
    }

    $(document).ready(function () {
        // Call updateList function every 5 seconds
        setInterval(UpdateAll, 200); // 5000 milliseconds = 5 seconds

        // var testJson = "{\"id\":\"6f6111de-16c4-4acb-8a54-79907ff68483\",\"plane\":{\"id\":\"16f19b53-75b7-4702-9205-1c6b374adb2b\",\"planeCode\":193,\"name\":\"Plane-193\",\"currentCoordinates\":{\"latDegrees\":28.784525137959402,\"latitude\":null,\"longDegrees\":-112.94861402962957,\"longitude\":null},\"onFlight\":true},\"startingAirport\":{\"id\":\"d45e406c-0138-465e-bc21-3cb281a2e779\",\"code\":15,\"name\":\"Airport-15\",\"coordinates\":{\"latDegrees\":9.884525137959244,\"latitude\":null,\"longDegrees\":-131.8486140296285,\"longitude\":null},\"capacity\":17,\"accessibleAirportCodes\":[0,1,4,5,6,7,8,9,11,18],\"planeList\":[]},\"destinationAirport\":{\"id\":\"fe8d2496-a334-4497-bf1e-3a2f8c2bfdbc\",\"code\":11,\"name\":\"Airport-11\",\"coordinates\":{\"latDegrees\":37.41549527085698,\"latitude\":null,\"longDegrees\":13.248991023629543,\"longitude\":null},\"capacity\":17,\"accessibleAirportCodes\":[2,3,4,5,7,8,9,10,12,13,15,16,17],\"planeList\":[]},\"status\":\"inFlight\"}\n";
        // var obj = JSON.parse(testJson);
        // console.log(obj);
        // console.log(obj.plane.currentCoordinates);
    });
</script>
</body>
</html>

