<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map Example</title>
    <!-- Include Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <!-- Include Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map {
            height: 520px;
            width: 520px;
        }
    </style>
</head>
<body>

<div id="map"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    var plane_icon = L.Icon.extend({
        options: {
            iconUrl: 'plane_icon.png',
            iconSize: [16, 16], // size of the icon
            shadowSize: [0, 0], // size of the shadow
            iconAnchor: [8, 8], // point of the icon which will correspond to marker's location
            shadowAnchor: [0, 0],  // the same for the shadow
            popupAnchor: [0, 0]
        }
    });

    var airport_icon = L.Icon.extend({
        options: {
            iconUrl: 'airport_icon.png',
            iconSize: [24, 24], // size of the icon
            shadowSize: [0, 0], // size of the shadow
            iconAnchor: [12, 12], // point of the icon which will correspond to marker's location
            shadowAnchor: [0, 0],  // the same for the shadow
            popupAnchor: [0, 0]
        }
    });

    // Initialize Leaflet map
    var map = L.map('map', {
        center: [51.505, -0.09],
        zoom: 1,
        maxBounds: L.latLngBounds(L.latLng(-90, -180), L.latLng(90, 180)),
        maxBoundsViscosity: 1.0,
        noWrap: true
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
        maxZoom: 18,
        noWrap: true
    }).addTo(map);

    var markersGroup = L.layerGroup().addTo(map);

    // Add marker
    function addMarker(latDegrees, longDegrees, message, type) {
        var marker;
        if (type === "plane") {
            marker = L.marker([latDegrees, longDegrees], {icon: new plane_icon()}).addTo(markersGroup);
        } else if (type === "airport") {
            marker = L.marker([latDegrees, longDegrees], {icon: new airport_icon()}).addTo(markersGroup);
        } else
        {
            marker = L.marker([latDegrees, longDegrees]).addTo(markersGroup);
        }
        marker.bindPopup(message);
    }

    function clearMarkers() {
        markersGroup.clearLayers();
    }

    function updateAirports() {
        $.get("/GetEnv", function (data) {
            // Assuming data is a JSON array of objects
            data.forEach(function (item) {
                var itemCoordinates = item.coordinates;
                addMarker(itemCoordinates.latDegrees,
                    itemCoordinates.longDegrees,
                    `<b>${item.code}</b><br>${item.name}.`,
                    "airport"
                )
            });
        });
    }

    function updatePlanes() {
        $.get("/Planes", function (data) {
            // Assuming data is a JSON array of objects
            if (data.length > 0) {
                data.forEach(function (item) {
                    var itemCoordinates = item.currentCoordinates;
                    addMarker(itemCoordinates.latDegrees,
                        itemCoordinates.longDegrees,
                        `<b>${item.planeCode}</b><br>${item.name}.`,
                        "plane"
                    )
                });
            }
        });
    }

    function UpdateAll()
    {
        clearMarkers();
        updateAirports();
        updatePlanes();
    }

    $(document).ready(function () {
        // Call updateList function every 5 seconds
        setInterval(UpdateAll, 200); // 5000 milliseconds = 5 seconds
    });
</script>

</body>
</html>
